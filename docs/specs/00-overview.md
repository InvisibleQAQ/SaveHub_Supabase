# SaveHub 知识管理改造 - 项目总览

> 将 Minne 知识管理功能移植到 SaveHub RSS 阅读器

## 项目背景

SaveHub 是一个成熟的 RSS 阅读器，具备完整的源管理、文章阅读、后台刷新等功能。本次改造将引入 Minne 项目的知识管理能力，使其从单纯的 RSS 阅读器升级为**个人知识管理平台**。

## 功能清单

### 现有功能（保持不变）
- RSS 源管理（添加、删除、编辑、刷新）
- 文章阅读（查看、标记已读、星标）
- 文件夹组织
- 内容搜索
- 实时同步（WebSocket）
- 后台任务（Celery）

### 新增功能（按优先级）

| 优先级 | 功能 | 描述 |
|--------|------|------|
| P0 | **知识图谱核心** | 知识实体 + 关系边 + 向量嵌入 |
| P1 | **混合检索** | 向量 + 全文 + 图遍历三路融合搜索 |
| P1 | **内容摄取管道** | URL/PDF/音频/图像/文本 → 知识实体 |
| P2 | **对话访问** | LLM驱动的知识问答（SSE流式+引用追溯） |
| P2 | **草稿系统** | 快速笔记 → 归档触发摄取 |
| P3 | **图可视化** | D3.js 力导向图展示知识关系 |
| P3 | **RSS 集成** | 文章自动流入知识图谱 |

---

## 功能依赖图

```
┌─────────────────────────────────────────────────────────────────┐
│                    SaveHub 知识管理架构                          │
└─────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────┐
                    │   系统设置          │
                    │ SystemSettings      │
                    │ (嵌入模型配置)      │
                    └────────┬────────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
      ┌───────▼────────┐ ┌──▼──────────┐ ┌─▼──────────┐
      │ Celery任务     │ │ 内容摄取    │ │ 草稿系统   │
      │ BackgroundTask │ │ Ingestion   │ │ Scratchpad │
      │ (状态追踪)     │ │ (5阶段管道) │ │ (输入)     │
      └────────┬───────┘ └──┬──────────┘ └─┬──────────┘
               │            │              │
               └────────────┼──────────────┘
                            │
                   ┌────────▼────────┐
                   │ 知识图谱核心    │
                   │ KnowledgeEntity │
                   │ RelatesTo       │
                   └────────┬────────┘
                            │
             ┌──────────────┼──────────────┐
             │              │              │
     ┌───────▼────────┐ ┌──▼──────────┐ ┌─▼──────────┐
     │ 混合检索       │ │ 图可视化    │ │ RSS集成    │
     │ HybridRetrieval│ │ D3 Graph    │ │ 文章提取   │
     │ (三路融合)     │ │ (关系展示)  │ │ (自动)     │
     └───────┬────────┘ └─────────────┘ └────────────┘
             │
     ┌───────▼────────┐
     │ 对话访问       │
     │ Conversation   │
     │ (知识问答)     │
     └────────────────┘
```

---

## 技术栈

### 现有技术栈（复用）
| 层 | 技术 |
|----|------|
| 前端 | Next.js 14 + React 18 + Zustand + shadcn/ui |
| 后端 | FastAPI + Celery + Redis |
| 数据库 | Supabase (PostgreSQL + RLS) |
| 认证 | Supabase JWT |

### 新增技术
| 用途 | 技术 |
|------|------|
| 向量存储 | pgvector (PostgreSQL 扩展) |
| 向量索引 | HNSW (1536维, 余弦距离) |
| 全文搜索 | PostgreSQL FTS + pg_trgm |
| LLM调用 | OpenAI兼容API (复用api_configs) |
| 图可视化 | D3.js v7 力导向图 |

---

## 实现阶段

### Phase 0: 规划文档（当前）
- 生成 10 个详细规格文档
- 确定数据模型和 API 设计

### Phase 1: 基础设施
- 启用 pgvector 扩展
- 实现 LLM 服务层

### Phase 2: 知识图谱核心
- 实体表 + 关系边表
- CRUD API + 向量搜索

### Phase 3: 内容摄取管道
- 5 阶段处理管道
- URL/PDF/音频/图像处理器

### Phase 4: 混合检索
- 向量 + 全文 + 图遍历
- 分数融合算法

### Phase 5: 对话系统
- SSE 流式响应
- 引用追溯

### Phase 6: 草稿 + 可视化
- 快速笔记输入
- D3.js 图渲染

### Phase 7: RSS 集成
- 文章自动提取实体
- Sidebar 集成

---

## 数据流概览

```
【输入层】
┌─────────────┬──────────┬────────┬────────┬────────┬────────┐
│ RSS文章     │ URL网页  │ PDF    │ 音频   │ 图片   │ 草稿   │
└─────┬───────┴────┬─────┴───┬────┴────┬───┴────┬───┴────┬───┘
      │            │         │         │        │        │
      └────────────┼─────────┼─────────┼────────┼────────┘
                   │         │         │        │
【摄取层】          │         │         │        │
┌──────────────────▼─────────▼─────────▼────────▼────────────┐
│ 内容摄取管道 (5阶段)                                        │
│ ├─ prepare      → 下载/解析原始内容                         │
│ ├─ retrieve     → 查询相关上下文                           │
│ ├─ enrich       → LLM提取实体和关系                        │
│ ├─ embed        → 生成向量嵌入                             │
│ └─ persist      → 保存到知识图谱                           │
└──────────────────┬─────────────────────────────────────────┘
                   │
【存储层】          │
┌──────────────────▼─────────────────────────────────────────┐
│ PostgreSQL + pgvector                                      │
│ ├─ knowledge_entity (HNSW向量索引)                         │
│ ├─ relates_to (关系边表)                                   │
│ ├─ content_source (内容源)                                 │
│ └─ conversation + message (对话)                           │
└──────────────────┬─────────────────────────────────────────┘
                   │
【查询层】          │
┌──────────────────▼─────────────────────────────────────────┐
│ 混合检索引擎                                               │
│ ├─ Vector Search (pgvector KNN)                           │
│ ├─ FTS Search (PostgreSQL全文)                            │
│ ├─ Graph Traversal (关系遍历)                             │
│ └─ Score Fusion (0.5v + 0.3f + 0.2g)                     │
└──────────────────┬─────────────────────────────────────────┘
                   │
【应用层】          │
┌──────────────────▼─────────────────────────────────────────┐
│ 用户界面                                                   │
│ ├─ 知识库页面 (实体列表/搜索)                              │
│ ├─ 对话页面 (问答+引用)                                   │
│ ├─ 图可视化 (D3力导向图)                                  │
│ └─ 内容摄取 (上传/导入)                                   │
└────────────────────────────────────────────────────────────┘
```

---

## 关键设计原则

### 1. 向后兼容
现有 RSS 功能完全不受影响，新功能作为独立模块添加。

### 2. 数据一致性
使用 PostgreSQL 事务保证实体、关系、嵌入的原子性写入。

### 3. 用户隔离
所有新表继承现有 RLS 策略模式（`user_id = auth.uid()`）。

### 4. 渐进增强
RSS 文章可选择性流入知识图谱，默认关闭避免性能影响。

### 5. 成本控制
LLM 调用使用用户自带的 API Key（复用 api_configs），无平台成本。

---

## 文件组织

### 文档目录
```
docs/specs/
├── 00-overview.md          # 本文件
├── 01-database-schema.md   # 数据库设计
├── 02-knowledge-graph.md   # 知识图谱规格
├── 03-content-ingestion.md # 内容摄取规格
├── 04-hybrid-retrieval.md  # 混合检索规格
├── 05-conversation.md      # 对话系统规格
├── 06-scratchpad.md        # 草稿系统规格
├── 07-visualization.md     # 图可视化规格
├── 08-api-endpoints.md     # API设计
└── 09-frontend-design.md   # 前端设计
```

### 代码目录（新增）
```
backend/app/
├── services/
│   ├── llm/           # LLM服务
│   ├── ingest/        # 内容摄取
│   └── retrieval/     # 混合检索
└── api/routers/
    ├── knowledge.py   # 知识实体API
    ├── relations.py   # 关系API
    ├── content.py     # 内容摄取API
    ├── conversation.py # 对话API
    ├── scratchpad.py  # 草稿API
    └── graph.py       # 图数据API

frontend/
├── lib/store/
│   ├── knowledge.slice.ts
│   ├── content.slice.ts
│   ├── conversation.slice.ts
│   └── scratchpad.slice.ts
├── components/
│   ├── knowledge/
│   ├── graph/
│   ├── ingest/
│   └── chat/
└── app/(reader)/
    ├── knowledge/
    ├── graph/
    ├── ingest/
    ├── scratchpad/
    └── chat/
```

---

## 下一步

继续阅读 `01-database-schema.md` 了解详细的数据库设计。
