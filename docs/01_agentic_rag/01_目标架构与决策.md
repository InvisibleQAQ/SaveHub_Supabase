# Agentic-RAG 目标架构与决策

## 1. 改造目标

把当前线性 `self_rag`（决策→检索→生成）升级为 `LangGraph` 驱动的 `agentic-rag`：

- 支持查询重写
- 支持多问题拆分并行处理
- 支持工具调用与迭代检索
- 支持人类澄清（问题不清晰时先追问）
- 最终回答严格“仅基于知识库”

## 2. 已锁定决策（不可变更）

- 新路由：`/api/agentic-rag/stream`
- 编排框架：`LangGraph`
- Chat 模型：支持 `tool calling`
- 前端：保留 `[ref:N]` 引用语法与 article/repository 卡片
- UI：展示 agent 中间过程状态（重写、工具调用、二次检索、聚合）
- 目标形态：最终只保留 `agentic-rag`（self-rag 下线）

## 3. 推荐目标架构

```text
Frontend Chat UI
  -> /api/agentic-rag/stream (SSE)
      -> AgenticRagService
          -> LangGraph Graph
              [Node] summarize/history
              [Node] rewrite + split
              [Node] clarification check
              [Subgraph] per-question agent loop
                  -> Tool: search_embeddings
                  -> Tool: expand_context (二次检索)
              [Node] aggregate answers
          -> 流式产出 content + stage 事件
```

## 4. 检索模型说明（结合你现有库）

你当前只有 `all_embeddings`（chunk级向量，1536维），没有 parent-child 索引层。

因此本次采用：

- **V1（已落地）**：chunk 检索 + 邻域扩展（二次检索）
- **V1.5（已落地）**：在现有 `all_embeddings` 上动态构造 `parent_id`，通过 `retrieve_parent_chunks` 回溯父块上下文
- **V2（后续可选）**：引入持久化 parent-child 结构（需要 schema 与重建索引）

## 5. 与参考项目的映射关系

参考项目 `/root/07_agentic-rag-for-dummies` 的核心思想保留：

- `analyze/rewrite/split`
- `tool loop`（搜索工具 + 补全工具）
- `search_child -> retrieve_parent` 层次检索语义（通过动态 parent_id 适配）
- `aggregate`
- `human clarification`

但不照搬其存储层（它是 parent-child + 本地向量库），而是适配你现有 Supabase `all_embeddings`。

## 6. 非目标（本次不做）

- 不强制引入新的向量数据库（如 Qdrant）
- 不要求一次性改造历史 embedding 数据
- 不要求性能压测到固定 SLA（你已确认无强约束）
