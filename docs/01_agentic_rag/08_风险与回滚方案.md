# 风险与回滚方案

## 1. 主要风险

## R1. Tool Calling 不稳定

症状：模型偶发不出 tool_calls，直接给答案。

缓解：
- system prompt 强约束“先检索再回答”
- 增加后验校验：无工具调用则强制触发一次检索

## R2. 引用编号错位

症状：`[ref:N]` 与来源卡片不一致。

缓解：
- 聚合前统一来源池去重与重排
- 聚合后做引用编号校验（无效引用直接报错或修正）

## R3. 多问题拆分导致时延增长

症状：复杂问题响应慢。

缓解：
- 限制最多拆分3个
- 限制每问题工具循环次数

## R4. 澄清流程中断用户体验

症状：用户不知道下一步要干什么。

缓解：
- 前端明确展示“请补充信息”状态
- 提供示例补充方式（如“我想比较性能和成本”）

---

## 2. 监控建议（最小集）

- 每轮问答日志字段：
  - query_id
  - rewritten_count
  - tool_call_count
  - retrieval_hit_count
  - clarification_triggered
  - total_latency_ms
- 错误日志聚合：按 `error_type` 统计

---

## 3. 回滚策略

你已要求最终只用 agentic-rag，但实际发布仍建议保留短期回滚窗口。

### 回滚层级

1. **前端回滚**：临时改回旧接口消费（若旧接口未删除）
2. **后端回滚**：停用 `agentic-rag` router，恢复 `rag-chat` router
3. **代码回滚**：git 回滚到发布前 tag

### 建议

- 在彻底删除 self-rag 前，至少保留一个发布周期的 fallback 分支

