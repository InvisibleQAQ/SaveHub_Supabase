# 待确认参数（执行前请填写）

> 本文件用于把实现中的可调参数固化，避免开发过程反复返工。
>
> 说明结构：
> - `当前值`：初始推荐配置
> - `作用`：该参数控制什么
> - `调大影响`：把值调高后的常见效果
> - `调小影响`：把值调低后的常见效果
> - `建议`：当前项目场景下的实操建议

## 0. 模型与版本基线（Phase 0 已确认）

### `chat_model`

- 当前值：`gemini-3-pro`
- 作用：Agent 推理、查询改写、答案生成、工具调用决策。
- 说明：你已确认该模型在当前环境可稳定 `tool calling`。

### `tool_calling_stability`

- 当前值：`stable`（已确认）
- 作用：标记当前模型在本环境的工具调用稳定性状态。
- 建议：进入 Phase 1 后继续通过日志监控 `tool_call` 触发率，若低于预期再做模型兜底。

### `dependency_lock_baseline`

- 当前值：`2026-02-10`
- 作用：记录后端依赖锁定基线日期，便于后续升级对比。

### `backend_dependency_versions`

- 当前值：
  ```yaml
  fastapi: 0.115.12
  uvicorn: 0.34.0
  supabase: 2.27.2
  gotrue: 2.12.4
  langchain: 1.2.6
  langchain-openai: 1.1.7
  langchain-community: 0.4.1
  langchain-experimental: 0.4.1
  langgraph: 1.0.6
  openai: 2.15.0
  pydantic: 2.12.5
  httpx: 0.28.1
  ```

## 1. 检索参数

### `top_k`

- 当前值：`8`
- 作用：每次向量检索初次召回的候选 chunk 数量。
- 调大影响：召回更全，命中率上升，但噪声和时延也会上升。
- 调小影响：响应更快，但容易漏掉关键证据。
- 建议：默认 `8` 合理；若“答非所问”较多可升到 `10-12`。

### `min_score`

- 当前值：`0.35`
- 作用：向量相似度下限（低于阈值的候选被过滤）。
- 调大影响：结果更“干净”，但可能无结果。
- 调小影响：结果更多，但低质量内容会混入。
- 建议：对你当前 article+repository 混合语料，`0.30-0.40` 是安全区间。

### `max_context_sources`

- 当前值：`12`
- 作用：单轮回答最多允许进入上下文/聚合的来源数量上限。
- 调大影响：信息更全，但 token 成本、引用重排复杂度上升。
- 调小影响：回答更聚焦，但可能遗漏细节。
- 建议：先保持 `12`，若上下文过长可降到 `8-10`。

## 2. Agent循环参数

### `max_split_questions`

- 当前值：`3`
- 作用：一次复杂问题最多拆成多少个子问题。
- 调大影响：覆盖更全，但总时延线性增加。
- 调小影响：速度更快，但复杂问题可能回答不完整。
- 建议：`3` 是平衡点；初期不建议超过 `4`。

### `max_tool_rounds_per_question`

- 当前值：`3`
- 作用：每个子问题最多允许多少轮“思考->调用工具->再思考”。
- 调大影响：更有机会修正检索，但易变慢，且可能循环。
- 调小影响：更快，但遇到难题时容易过早结束。
- 建议：保持 `3`，并配合超时保护。

### `max_expand_calls_per_question`

- 当前值：`2`
- 作用：每个子问题最多触发几次二次检索/上下文扩展（`expand_context`）。
- 调大影响：上下文更完整，但噪声和成本上升。
- 调小影响：效率更高，但“断章”风险增加。
- 建议：先用 `2`；若经常出现上下文不完整可升到 `3`。

### `rewrite_temperature`

- 当前值：`0.1`
- 作用：查询改写与拆分阶段的采样温度。
- 调大影响：改写更发散，可能引入偏题。
- 调小影响：结果更稳定、可重复。
- 建议：该阶段应追求稳定，保持 `0.0-0.2`。

### `answer_temperature`

- 当前值：`0.2`
- 作用：最终回答生成温度。
- 调大影响：表达更灵活，但“仅基于知识库”约束更难守住。
- 调小影响：更严谨一致，但文风偏保守。
- 建议：严格知识库问答建议 `0.1-0.3`。

## 3. 澄清参数

### `enable_clarification`

- 当前值：`true`
- 作用：是否启用人类澄清回路（问题不清楚时先追问）。
- 调整影响：关闭后流程更直，但对含糊问题准确率明显下降。
- 建议：你已明确需要该能力，保持 `true`。

### `clarification_min_length`

- 当前值：`10`
- 作用：用于判断“澄清提示是否足够具体”的最小长度阈值。
- 调大影响：可过滤太短提示，但可能误判有效简短澄清。
- 调小影响：更容易通过，但可能出现无效澄清文案。
- 建议：中文场景 `10-20` 合理，先用 `10`。

### `clarification_timeout_sec`

- 当前值：`120`
- 作用：等待用户补充澄清输入的会话超时时间（秒）。
- 调大影响：用户更从容，但会话资源占用更久。
- 调小影响：系统释放更快，但用户体验可能受影响。
- 建议：桌面端聊天推荐 `120-300`，先用 `120`。

## 4. 前端显示参数

### `show_agent_timeline`

- 当前值：`true`
- 作用：是否展示 Agent 阶段时间线（改写、工具调用、聚合等）。
- 建议：你要求“可解释过程”，保持开启。

### `max_timeline_items`

- 当前值：`5`
- 作用：界面最多显示多少条最近过程事件。
- 调大影响：信息更全，但 UI 更拥挤。
- 调小影响：更简洁，但可观察性下降。
- 建议：`5` 适合当前聊天面板密度。

### `show_tool_args`

- 当前值：`false`
- 作用：是否在前端展示工具调用参数详情。
- 调整影响：开启后更利于调试，但会暴露内部检索细节、增加认知负担。
- 建议：生产默认 `false`，仅调试环境可临时打开。

## 5. 失败处理策略

### 工具失败是否重试

- 当前值：`true`
- 解释：网络抖动或瞬时超时时，允许工具自动再试一次。

### 单工具最大重试次数

- 当前值：`1`
- 解释：最多重试一次，避免在故障时进入长等待。

### 失败后是否继续生成回答

- 当前策略：`仅在已有有效来源时继续`
- 解释：保证“仅基于知识库”原则，不允许在无证据时硬答。

---

## 6. 首轮上线推荐基线（可直接采用）

```yaml
top_k: 8
min_score: 0.35
max_context_sources: 12
max_split_questions: 3
max_tool_rounds_per_question: 3
max_expand_calls_per_question: 2
rewrite_temperature: 0.1
answer_temperature: 0.2
enable_clarification: true
clarification_min_length: 10
clarification_timeout_sec: 120
show_agent_timeline: true
max_timeline_items: 5
show_tool_args: false
retry_tool_on_failure: true
max_tool_retry: 1
continue_on_tool_failure_with_sources_only: true
```
