# 前端实施步骤（保留引用样式 + 增强 Agent 状态）

## 1. 文件级改造建议

### 新增

- `frontend/lib/api/agentic-rag.ts`
- `frontend/components/chat/agentic-status-timeline.tsx`（可选）

### 修改

- `frontend/components/chat/chat-page.tsx`
- `frontend/components/chat/chat-status.tsx`（可扩展为阶段型状态）
- 如有需要：`frontend/lib/types.ts`

---

## 2. API 客户端改造

新增 `agentic-rag.ts`，仿照 `rag-chat.ts` 的 SSE 处理，但事件类型升级。

### 目标

- 请求地址：`/api/agentic-rag/stream`
- 支持新的中间事件：`rewrite`, `tool_call`, `tool_result`, `clarification_required`, `aggregation`
- 保持 `content`, `done`, `error` 的消费逻辑

---

## 3. Chat 页面状态机改造

当前 `ChatPage` 只处理 `decision/retrieval/content/assessment/done`。

### 建议状态映射

- `rewrite` -> `正在重写与拆分问题...`
- `tool_call` -> `正在调用检索工具...`
- `tool_result` -> `已获取检索结果，分析中...`
- `clarification_required` -> `需要你补充信息`
- `aggregation` -> `正在聚合多问题答案...`
- `content` -> `生成回答中...`

---

## 4. 澄清交互（Human-in-the-loop）

当收到 `clarification_required`：

1. 停止当前自动流
2. 将澄清问题作为 assistant 消息插入聊天
3. 等待用户补充后再次发送

> 这是与旧 self-rag 最大交互差异之一。

---

## 5. 引用与来源卡片保持不变

你已明确要求不变，故以下组件尽量不改：

- `frontend/components/chat/referenced-content.tsx`
- `frontend/components/chat/reference-marker.tsx`
- `frontend/components/chat/article-reference-card.tsx`
- `frontend/components/chat/repository-reference-card.tsx`

前提：后端仍输出兼容的 `[ref:N]` 与 `sources[]`。

---

## 6. 可视化建议（轻量实现）

可在 `ChatStatus` 下方加一个简易时间线（最新5条）：

- 重写完成（子问题数：N）
- 工具调用（search_embeddings）
- 二次检索（expand_context）
- 聚合答案

这可以明显提升“agent 正在工作”的可解释性。

---

## 7. 前端验收要点

- 用户能看见 agent 分阶段状态
- 澄清问题可闭环
- 引用 marker 点击卡片展示正常
- repository/article 两类来源卡片字段完整

